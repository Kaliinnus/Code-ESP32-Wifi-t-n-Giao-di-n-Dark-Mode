#include <WiFi.h>
#include <WebServer.h>
#include <IRremoteESP8266.h>
#include <IRrecv.h>
#include <IRutils.h>

const uint16_t kRecvPin = 15; 
IRrecv irrecv(kRecvPin);
decode_results results;

String lastCode = "Đang đợi tín hiệu...";
String lastProtocol = "---";

WebServer server(80);

// Giao diện Web Dark Mode màu đen dễ nhìn
void handleRoot() {
  String html = "<html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'>";
  html += "<style>";
  html += "body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }";
  html += ".container { max-width: 400px; margin: auto; background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }";
  html += "h1 { color: #00e676; font-size: 22px; margin-bottom: 20px; }";
  html += ".label { color: #888; font-size: 14px; margin-top: 15px; text-transform: uppercase; }";
  html += ".value { color: #ffffff; font-size: 24px; font-weight: bold; margin: 10px 0; letter-spacing: 1px; }";
  html += ".footer { margin-top: 30px; font-size: 12px; color: #555; }";
  html += "</style>";
  html += "<script>setInterval(function(){location.reload();}, 1500);</script>";
  html += "</head><body>";
  html += "<div class='container'>";
  html += "<h1>BỘ THU MÃ HỒNG NGOẠI</h1>";
  
  html += "<div class='label'>Giao thức (Protocol)</div>";
  html += "<div class='value' style='color: #ff9800;'>" + lastProtocol + "</div>";
  
  html += "<div class='label'>Mã số (Hex Code)</div>";
  html += "<div class='value' style='color: #2196f3;'>" + lastCode + "</div>";
  
  html += "<div class='footer'>Hướng Remote vào mắt thu để lấy mã</div>";
  html += "</div></body></html>";
  
  server.send(200, "text/html", html);
}

void setup() {
  Serial.begin(115200);
  irrecv.enableIRIn();

  // Đổi tên Wifi thành dấu chấm ●
  // Lưu ý: Một số điện thoại cũ có thể hiển thị lỗi font, nhưng đa số smartphone đời mới đều thấy rõ
  WiFi.softAP("●", ""); 

  server.on("/", handleRoot);
  server.begin();
  Serial.println("Wifi '●' đã sẵn sàng tại 192.168.4.1");
}

void loop() {
  server.handleClient();

  if (irrecv.decode(&results)) {
    lastProtocol = typeToString(results.decode_type);
    lastCode = "0x" + uint64ToString(results.value, 16);
    irrecv.resume(); 
  }
}
